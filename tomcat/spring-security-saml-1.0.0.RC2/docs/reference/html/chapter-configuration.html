<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>4.&nbsp;Configuration and integration</title><link rel="stylesheet" href="css/manual-multipage.css" type="text/css"><meta name="generator" content="DocBook XSL Stylesheets V1.75.2"><link rel="home" href="index.html" title="Spring Security SAML Extension"><link rel="up" href="integration.html" title="Part&nbsp;II.&nbsp;Configuring SSO with SAML"><link rel="prev" href="integration.html" title="Part&nbsp;II.&nbsp;Configuring SSO with SAML"><link rel="next" href="chapter-administration-ui.html" title="5.&nbsp;Administration user interface"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">4.&nbsp;Configuration and integration</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="integration.html">Prev</a>&nbsp;</td><th width="60%" align="center">Part&nbsp;II.&nbsp;Configuring SSO with SAML</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="chapter-administration-ui.html">Next</a></td></tr></table><hr></div><div class="chapter" title="4.&nbsp;Configuration and integration"><div class="titlepage"><div><div><h2 class="title"><a name="chapter-configuration"></a>4.&nbsp;Configuration and integration</h2></div></div></div>
	
	<p>This chapter will discuss aspects of configuring and using the library in target applications.</p>

	<div class="section" title="4.1&nbsp;Overview"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="configuration-overview"></a>4.1&nbsp;Overview</h2></div></div></div>
		
		<p>Spring Security SAML 2.0 library comprises three modules:
			</p><div class="itemizedlist"><ul class="itemizedlist" type="disc" compact><li class="listitem">
					<p>
						<span class="emphasis"><em>saml2-core</em></span>
						contains implementation of the WebSSO profiles of the SAML 2.0 protocol and is required for
						integration to target systems.
					</p>
				</li><li class="listitem">
					<p>
						<span class="emphasis"><em>saml2-sample</em></span>
						contains example of Spring configuration used for integration to target systems. It also
						contains user interface for generation and management of metadata.
					</p>
				</li><li class="listitem">
					<p>
						<span class="emphasis"><em>saml2-doc</em></span>
						contains this documentation.
					</p>
				</li></ul></div><p>
		</p>
		<p>Configuration of library is done using Spring context XML. An example of configuration can be found
			under<span class="emphasis"><em>saml2-sample/src/main/resources/security/securityContext.xml</em></span>.
			Setting up of the library typically involves these steps:
			</p><div class="itemizedlist"><ul class="itemizedlist" type="disc" compact><li class="listitem">
					<p>integration to application using Spring XML configuration</p>
				</li><li class="listitem">
					<p>configuration of signature, encryption and trust keys</p>
				</li><li class="listitem">
					<p>configuration of security profiles</p>
				</li><li class="listitem">
					<p>import, generation and customization of SP and IDP metadata</p>
				</li><li class="listitem">
					<p>configuration of IDP selection</p>
				</li><li class="listitem">
					<p>configuration of single sign-on process</p>
				</li><li class="listitem">
					<p>configuration of logout process</p>
				</li><li class="listitem">
					<p>configuration of authentication object</p>
				</li></ul></div><p>
		</p>
		<p>Additional steps such as configuration of authentication logging, customization of SAML 2.0 bindings,
			configuration of artifact resolution or configuration of time skews might be needed.
		</p>
	</div>

	<div class="section" title="4.2&nbsp;Integration to applications"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="configuration-integration"></a>4.2&nbsp;Integration to applications</h2></div></div></div>
		
		<p>SAML module can be directly embedded into new of existing Spring applications. In
			this case application itself includes the SAML library in WEB-INF/lib directory of the war archive and
			processes all SAML interactions. The other option of using the SAML library is deploying it as a
			stand-alone module
			which transfers information about the authenticated user to the target application using a custom
			mechanism. This chapter only discusses the first option.
		</p>
		<div class="section" title="4.2.1&nbsp;Maven dependency"><div class="titlepage"><div><div><h3 class="title"><a name="configuration-integration-maven"></a>4.2.1&nbsp;Maven dependency</h3></div></div></div>
			
			<p>
				In order to include the library and all it's dependencies add the following dependency to your
				pom.xml file:
				</p><pre class="programlisting">&lt;dependency&gt;
	&lt;groupId&gt;org.springframework.security.extensions&lt;/groupId&gt;
	&lt;artifactId&gt;spring-security-saml2-core&lt;/artifactId&gt;
	&lt;version&gt;${version}&lt;/version&gt;
&lt;/dependency&gt;</pre><p>
			</p>
			<p>The current version of SAML Extension has been tested to work with Spring 3.1.2, Spring Security 3.1.2 and OpenSAML 2.5.3.
			Later versions of these libraries are likely to be compatible without modifications.</p>
		</div>
		<div class="section" title="4.2.2&nbsp;Bean definitions"><div class="titlepage"><div><div><h3 class="title"><a name="configuration-integration-bean-definitions"></a>4.2.2&nbsp;Bean definitions</h3></div></div></div>
			
			<p>Configuration of the SAML library requires beans definitions included in the
				<span class="emphasis"><em>saml2-sample/src/main/resources/security/securityContext.xml</em></span>
				configuration file. Include copy of the file in your own Spring application, either directly or with
				an inclusion. Configuration steps in the following chapters will be customizing beans included in
				the default context.
			</p>
			<p>Beans of the SAML library are using auto-wiring and annotation-based configuration by default.
				Make sure that your Spring configuration
				contains e.g. the following settings in order to enable support for these features:
				</p><pre class="programlisting">&lt;context:annotation-config/&gt;
&lt;context:component-scan base-package="org.springframework.security.saml"/&gt;
</pre><p>
				</p>
			</div>
			<div class="section" title="4.2.3&nbsp;Spring Security integration"><div class="titlepage"><div><div><h3 class="title"><a name="configuration-integration-spring-security"></a>4.2.3&nbsp;Spring Security integration</h3></div></div></div>
				
				<p>Filters of the SAML module need to be enabled as part of the Spring Security settings. In case
					SAML authentication should be the default authentication mechanism of the application set bean
					<span class="emphasis"><em>samlEntryPoint</em></span>
					as the default entry point. Make sure that filter
					<span class="emphasis"><em>samlFilter</em></span>
					is included as one of the custom filters. In case SP metadata should be
					generated automatically during first request to the application include also filter<span class="emphasis"><em>
						metadataGeneratorFilter</em></span>.
					The configuration directive may for example look as follows:
					</p><pre class="programlisting">&lt;security:http entry-point-ref="samlEntryPoint"&gt;
	&lt;security:custom-filter before="FIRST" ref="metadataGeneratorFilter"/&gt;
	&lt;security:custom-filter after="BASIC_AUTH_FILTER" ref="samlFilter"/&gt;
&lt;/security:http&gt;</pre><p>
			</p>
		</div>
	</div>

	

	<div class="section" title="4.3&nbsp;Metadata configuration"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="configuration-metadata"></a>4.3&nbsp;Metadata configuration</h2></div></div></div>
		
		<p>
			SAML metadata is an XML document which contains information necessary for interaction with SAML-enabled identity
			or service providers. Document contains e.g. URLs of endpoints, information about supported bindings, identifiers and
			public keys. Typically one metadata document will be generated for your own service provider and sent to all identity providers
			you want to enable single sign-on with. Similarly, each identity provider will make it's own metadata available for you to import
			into your service provider application.
		</p>
		<p>
			Each metadata document can contain definition for one or many identity or service providers and optionally can be digitally signed.
			Metadata can be customized either by direct modifications to the XML document, or using extended metadata. Extended metadata is added
			directly to the Spring configuration file and can contain additional options which are unavailable in the basic metadata document.
		</p>

		<div class="section" title="4.3.1&nbsp;Service provider metadata"><div class="titlepage"><div><div><h3 class="title"><a name="configuration-metadata-sp"></a>4.3.1&nbsp;Service provider metadata</h3></div></div></div>
			
			<p>Service provider metadata contains keys, services and URLs defining SAML endpoints of your application. Metadata can be either
			generated automatically upon first request to the service, or it can be pre-created (see <a class="xref" href="chapter-administration-ui.html" title="5.&nbsp;Administration user interface">Chapter&nbsp;5, <i>Administration user interface</i></a>).
			Once created metadata needs to be provided to the identity providers with whom we want to establish trust.</p>

			<div class="section" title="Automatic metadata generation"><div class="titlepage"><div><div><h4 class="title"><a name="configuration-metadata-sp-generation"></a>Automatic metadata generation</h4></div></div></div>
				
				<p>
					Automatic metadata generation is enabled by including the following filter in the Spring Security configuration:
					</p><pre class="programlisting">&lt;security:custom-filter before="FIRST" ref="metadataGeneratorFilter"/&gt;</pre><p>
				</p>
				<p>
					Filter is automatically invoked as part of the first request to a URL processed by Spring Security. In case there
					is no service provider metadata already specified (meaning property <span class="emphasis"><em>hostedSPName</em></span> of the
					<span class="emphasis"><em>metadata</em></span> bean is empty) filter will generate a new one.
				</p>
				<p>
					By default metadata will be generated with the following values which can be customized by setting properties of the <span class="emphasis"><em>metadataGenerator</em></span> bean:
					</p><div class="table"><a name="configuration-metadata-sp-generation-default-values"></a><p class="title"><b>Table&nbsp;4.1.&nbsp;Metadata generator settings</b></p><div class="table-contents">
						
						<table summary="Metadata generator settings" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col align="left"><col align="left"><col align="left"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Property</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Description</th><th style="border-bottom: 0.5pt solid ; " align="left">Default value</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left"><code class="literal">entityBaseURL</code></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Base URL to construct SAML endpoints from, needs to be a URL with protocol, server, port and context path.</td><td style="border-bottom: 0.5pt solid ; " align="left">Values from the request in format: <span class="emphasis"><em>scheme://server:port/contextPath</em></span></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left"><code class="literal">entityAlias</code></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Local alias for the entityId which can be part of a simple URL path and contains only alphanum characters. See <a class="xref" href="chapter-configuration.html#configuration-entity-alias" title="4.4&nbsp;Entity alias">Section&nbsp;4.4, &#8220;Entity alias&#8221;</a>.</td><td style="border-bottom: 0.5pt solid ; " align="left"><span class="emphasis"><em>defaultAlias</em></span></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left"><code class="literal">entityId</code></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Unique identifier of the service provider.</td><td style="border-bottom: 0.5pt solid ; " align="left">&lt;entityBaseUrl&gt;/saml/ metadata/alias/&lt;entityAlias&gt;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left"><code class="literal">requestSigned</code></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Flag indicating whether this service signs authentication requests.</td><td style="border-bottom: 0.5pt solid ; " align="left">true</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left"><code class="literal">wantAssertionSigned</code></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Flag indicating whether this service requires signed assertions.</td><td style="border-bottom: 0.5pt solid ; " align="left">true</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left"><code class="literal">signingKey</code></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Key to include with usage "signing" in the metadata. Value will be set in ExtendedMetadata as <code class="literal">signingKey</code>.</td><td style="border-bottom: 0.5pt solid ; " align="left">Default private key from the KeyManager</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left"><code class="literal">encryptionKey</code></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Key to include with usage "encryption" in the metadata. Value will be set in ExtendedMetadata as <code class="literal">encryptionKey</code>.</td><td style="border-bottom: 0.5pt solid ; " align="left">Default private key from the KeyManager</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left"><code class="literal">tlsKey</code></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Key to include with usage "unspecified" in the metadata. Value will be set in ExtendedMetadata as <code class="literal">tlsKey</code>.</td><td style="border-bottom: 0.5pt solid ; " align="left">By default not included. Key is only included in metadata when it's different from signing and encryption keys.</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left"><code class="literal">signMetadata</code></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">When true generated metadata will be signed using XML Signature using certificate with alias of <code class="literal">signingKey</code>.</td><td style="border-bottom: 0.5pt solid ; " align="left">true</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left"><code class="literal">bindingsSSO</code></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Bindings to be included in the metadata for WebSSO profile. Supported values are: POST, Artifact and PAOS. Order of bindings in the property determines order of endpoints in the generated metadata.</td><td style="border-bottom: 0.5pt solid ; " align="left">Artifact, POST, PAOS</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left"><code class="literal">bindingsHoKSSO</code></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Bindings to be included in the metadata for WebSSO Holder-of-Key profile. Supported values are: POST and Artifact. Order of bindings in the property determines order of endpoints in the generated metadata.</td><td style="border-bottom: 0.5pt solid ; " align="left">Artifact, POST</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left"><code class="literal">bindingsSLO</code></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Bindings to be included in the metadata for Single Logout profile. Supported values are: POST and Redirect. Order of bindings in the property determines order of endpoints in the generated metadata.</td><td style="border-bottom: 0.5pt solid ; " align="left">POST, Redirect</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left"><code class="literal">assertionConsumerIndex</code></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Index of assertion consumer point to be marked as default.</td><td style="border-bottom: 0.5pt solid ; " align="left">0</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left"><code class="literal">includeDiscovery</code></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">When true system will initialize discovery process during attempt to initialize single sign-on without pre-selected IDP.</td><td style="border-bottom: 0.5pt solid ; " align="left">true</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left"><code class="literal">customDiscoveryURL</code></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">When <code class="literal">includeDiscovery</code> is true value overrides default discovery request URL.</td><td style="border-bottom: 0.5pt solid ; " align="left">generated value for internal discovery service</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left"><code class="literal">customDiscoveryResponseURL</code></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">When <code class="literal">includeDiscoveryExtension</code> is true value overrides default discovery response URL.</td><td style="border-bottom: 0.5pt solid ; " align="left">generated value for entry point response URL</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left"><code class="literal">includeDiscoveryExtension</code></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">When true generated metadata will contain extension indicating that it's able to consume response from an IDP Discovery service.</td><td style="border-bottom: 0.5pt solid ; " align="left">false</td></tr><tr><td style="border-right: 0.5pt solid ; " align="left"><code class="literal">nameID</code></td><td style="border-right: 0.5pt solid ; " align="left">Name identifiers to be included in the metadata. Supported values are: EMAIL, TRANSIENT, PERSISTENT, UNSPECIFIED and X509_SUBJECT. Order of NameIDs in the property determines order of NameIDs in the generated metadata.</td><td style="" align="left">EMAIL, TRANSIENT, PERSISTENT, UNSPECIFIED, X509_SUBJECT</td></tr></tbody></table>
					</div></div><p><br class="table-break">
				</p>
				<p>
					Property <code class="literal">entityBaseUrl</code> is automatically generated based on values in the first HTTP request, unless explictly specified in the MetadataGenerator.
					Generated value can be normalized to exclude standard 80/443 ports for http/https schemes by setting property <code class="literal">normalizeBaseUrl</code> of the MetadataGeneratorFilter
					to <code class="literal">true</code>.
				</p>
				<p>
					Providing an empty collection or null value to properties <span class="emphasis"><em>bindingsSSO</em></span>, <span class="emphasis"><em>bindingsHoKSSO</em></span> and <span class="emphasis"><em>bindingsSLO</em></span>
					will disable and remove the given profile. For example the following setting removes the holder-of-key profile from the generated metadata,
					forces artifact binding for single sign-on and redirect binding for single logout: </p><pre class="programlisting">&lt;bean class="org.springframework.security.saml.metadata.MetadataGenerator"&gt;
	&lt;property name="bindingsSSO"&gt;&lt;list&gt;&lt;value&gt;artifact&lt;/value&gt;&lt;/list&gt;&lt;/property&gt;
	&lt;property name="bindingsSLO"&gt;&lt;list&gt;&lt;value&gt;redirect&lt;/value&gt;&lt;/list&gt;&lt;/property&gt;
	&lt;property name="bindingsHoKSSO"&gt;&lt;list/&gt;&lt;/property&gt;
&lt;/bean&gt;</pre>
				<p>
					By default generated metadata will be digitally signed using the default credential specified in KeyManager
					(see <a class="xref" href="chapter-configuration.html#configuration-key-management" title="4.5&nbsp;Key management">Section&nbsp;4.5, &#8220;Key management&#8221;</a> for details). Digital signature can be disabled using property
					<code class="literal">signMetadata</code> of the <span class="emphasis"><em>metadataGeneratorFilter</em></span> bean.
				</p>
				<p>
					In case application is deployed behind a reverse-proxy or other mechanism which makes the URL at the application server different
					from the URL seen by client at least property <code class="literal">entityBaseURL</code> should be set to a value e.g. https://www.server.com:8080
					For details about load balancing see <a class="xref" href="chapter-configuration.html#load-balancing" title="4.14&nbsp;Load balancing">Section&nbsp;4.14, &#8220;Load balancing&#8221;</a>.
				</p>
			</div>

			<div class="section" title="Pre-configured metadata"><div class="titlepage"><div><div><h4 class="title"><a name="configuration-metadata-sp-import"></a>Pre-configured metadata</h4></div></div></div>
				
				<p>In some situations it is beneficial to provide static version of the metadata document instead of the automatic generation. Need
				for manual changes in the metadata or fixing of production settings are some of those. Custom metadata document describing local SP application
				can be added by updating the <span class="emphasis"><em>metadata</em></span> bean with correct <span class="emphasis"><em>ExtendedMetadata</em></span>. Please follow these steps
				in order to do so: </p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
					  <p>Generate and download metadata, e.g. using the <span class="emphasis"><em>Metadata information -&gt; Generate new service provider metadata</em></span> option in the sample application's administration UI or using instructions in <a class="xref" href="chapter-configuration.html#configuration-metadata-sp-generation" title="Automatic metadata generation">the section called &#8220;Automatic metadata generation&#8221;</a>.</p>
				  </li><li class="listitem">
					  <p>Store the metadata file as part of your project classpath, e.g. in <span class="emphasis"><em>WEB-INF/classes/security/localhost_sp.xml</em></span>.</p>
				  </li><li class="listitem">
					  <p>Disable the automatic metadata generator by removing the following custom filter from the <span class="emphasis"><em>securityContext.xml</em></span>: </p><pre class="programlisting">&lt;security:custom-filter before="FIRST" ref="metadataGeneratorFilter"/&gt;</pre>
				  </li><li class="listitem">
					  <p>Include the SP metadata in the <span class="emphasis"><em>metadata</em></span> bean and mark the entity as <span class="emphasis"><em>local</em></span> in the extended metadata. Make sure to specify the <span class="emphasis"><em>alias</em></span>
					  property in case it was used during metadata generation.</p>
					  <p>It is recommended to use the administration UI which also generates all the Spring declarations ready for inclusion in your <span class="emphasis"><em>securityContext.xml</em></span>.</p>
					  <pre class="programlisting">&lt;bean class="org.springframework.security.saml.metadata.ExtendedMetadataDelegate"&gt;
	&lt;constructor-arg&gt;
		&lt;bean class="org.opensaml.saml2.metadata.provider.FilesystemMetadataProvider"&gt;
			&lt;constructor-arg&gt;
				&lt;value type="java.io.File"&gt;classpath:security/localhost_sp.xml&lt;/value&gt;
			&lt;/constructor-arg&gt;
			&lt;property name="parserPool" ref="parserPool"/&gt;
		&lt;/bean&gt;
	&lt;/constructor-arg&gt;
	&lt;constructor-arg&gt;
		&lt;bean class="org.springframework.security.saml.metadata.ExtendedMetadata"&gt;
		   &lt;property name="local" value="true"/&gt;
		   &lt;property name="alias" value="default"/&gt;
		   &lt;property name="securityProfile" value="metaiop"/&gt;
		   &lt;property name="sslSecurityProfile" value="pkix"/&gt;
		   &lt;property name="signingKey" value="apollo"/&gt;
		   &lt;property name="encryptionKey" value="apollo"/&gt;
		   &lt;property name="requireArtifactResolveSigned" value="false"/&gt;
		   &lt;property name="requireLogoutRequestSigned" value="false"/&gt;
		   &lt;property name="requireLogoutResponseSigned" value="false"/&gt;
		   &lt;property name="idpDiscoveryEnabled" value="true"/&gt;
		   &lt;property name="idpDiscoveryURL"
			  value="https://www.server.com:8080/context/saml/discovery/alias/default"/&gt;
		   &lt;property name="idpDiscoveryResponseURL"
			  value="https://www.server.com:8080/context/saml/login/alias/default?disco=true"/&gt;
		&lt;/bean&gt;
	&lt;/constructor-arg&gt;
&lt;/bean&gt;</pre>
				  </li></ul></div>
				<p>Same instance of your application can include multiple statically declared local service providers each differentiated with it's own unique
				alias and entity ID. Each service provider can e.g. process a different domain or have different security key settings. This feature makes it possible to create multi-tenant applications with
				individual SAML settings for each of the tenants. In case multiple local SPs are declared, property <span class="emphasis"><em>hostedSPName</em></span> of the <span class="emphasis"><em>metadata</em></span>
				bean should be set to the entity ID of the default one.</p>
				<p>For details about available settings of the ExtendedMetadata see <a class="xref" href="chapter-configuration-reference.html#reference-extended-metadata" title="A.1&nbsp;Extended metadata">Section&nbsp;A.1, &#8220;Extended metadata&#8221;</a>.</p>
			</div>

			<div class="section" title="Downloading metadata"><div class="titlepage"><div><div><h4 class="title"><a name="configuration-metadata-sp-display"></a>Downloading metadata</h4></div></div></div>
				
				<p>Metadata describing the default local application can be downloaded from URL: </p><pre class="programlisting">https://www.server.com:8080/context/saml/metadata</pre>
				<p>In case application is configured to contain multiple service providers metadata for each can be loaded by
				adding the alias: </p><pre class="programlisting">https://www.server.com:8080/context/saml/login/alias/defaultAlias</pre>
				<p>URL for metadata download can be disabled by removing filter <span class="emphasis"><em>metadataDisplayFilter</em></span> from the <span class="emphasis"><em>securityContext.xml</em></span>.</p>
				<p>Metadata is also available in the sample application's administration UI under <span class="emphasis"><em>Metadata information -&gt; selected SP</em></span>.</p>
			</div>
		</div>

		<div class="section" title="4.3.2&nbsp;Identity provider metadata"><div class="titlepage"><div><div><h3 class="title"><a name="configuration-metadata-idp"></a>4.3.2&nbsp;Identity provider metadata</h3></div></div></div>
			
			<p>Metadata for identity providers is imported to the <span class="emphasis"><em>metadataManager</em></span> in a similar way as pre-configured
			SP metadata. Metadata containing one or many identity providers can be added by providing an URL or a file. Processing of metadata and
			processing of SAML messages can be customized using properties of <span class="emphasis"><em>ExtendedMetadataDelegate</em></span> and <span class="emphasis"><em>ExtendedMetadata</em></span>.</p>

			<div class="section" title="File-based metadata provider"><div class="titlepage"><div><div><h4 class="title"><a name="configuration-metadata-idp-file"></a>File-based metadata provider</h4></div></div></div>
				
				<p>File-based provider loads metadata from a file available in the filesystem or classpath.</p><pre class="programlisting">&lt;bean class="org.springframework.security.saml.metadata.ExtendedMetadataDelegate"&gt;
	&lt;constructor-arg&gt;
		&lt;bean class="org.opensaml.saml2.metadata.provider.FilesystemMetadataProvider"&gt;
			&lt;constructor-arg&gt;
				&lt;value type="java.io.File"&gt;classpath:security/idp.xml&lt;/value&gt;
			&lt;/constructor-arg&gt;
			&lt;property name="parserPool" ref="parserPool"/&gt;
		&lt;/bean&gt;
	&lt;/constructor-arg&gt;
	&lt;constructor-arg&gt;
		&lt;bean class="org.springframework.security.saml.metadata.ExtendedMetadata"/&gt;
	&lt;/constructor-arg&gt;
&lt;/bean&gt;</pre>
			  <p>Metadata is automatically refreshed in intervals specified by properties <span class="emphasis"><em>minRefreshDelay</em></span> and <span class="emphasis"><em>maxRefreshDelay</em></span> of the <span class="emphasis"><em>MetadataProvider</em></span> bean.</p>
			</div>

			<div class="section" title="HTTP-based metadata provider"><div class="titlepage"><div><div><h4 class="title"><a name="configuration-metadata-idp-http"></a>HTTP-based metadata provider</h4></div></div></div>
				
				<p>HTTP-based provider loads metadata from an URL.</p><pre class="programlisting">&lt;bean class="org.springframework.security.saml.metadata.ExtendedMetadataDelegate"&gt;
	&lt;constructor-arg&gt;
		&lt;bean class="org.opensaml.saml2.metadata.provider.HTTPMetadataProvider"&gt;
			&lt;constructor-arg&gt;
				&lt;value type="java.lang.String"&gt;http://idp.ssocircle.com/idp-meta.xml&lt;/value&gt;
			&lt;/constructor-arg&gt;
			&lt;constructor-arg&gt;
				&lt;!-- Timeout for metadata loading in ms --&gt;
				&lt;value type="int"&gt;5000&lt;/value&gt;
			&lt;/constructor-arg&gt;
			&lt;property name="parserPool" ref="parserPool"/&gt;
		&lt;/bean&gt;
	&lt;/constructor-arg&gt;
	&lt;constructor-arg&gt;
		&lt;bean class="org.springframework.security.saml.metadata.ExtendedMetadata"/&gt;
	&lt;/constructor-arg&gt;
&lt;/bean&gt;</pre>
				<p>Metadata is automatically refreshed in intervals specified by properties <span class="emphasis"><em>minRefreshDelay</em></span> and <span class="emphasis"><em>maxRefreshDelay</em></span> of the <span class="emphasis"><em>MetadataProvider</em></span> bean.</p>
				<p>Alternatively class <span class="emphasis"><em>org.opensaml.saml2.metadata.provider.FileBackedHTTPMetadataProvider</em></span> can be used to provide a backup in case URL is temporarily unavailable. File
				to use as backup is specified as third argument in the <span class="emphasis"><em>MetadataProvider</em></span> bean constructor.</p>
			</div>

			<div class="section" title="Signature verification"><div class="titlepage"><div><div><h4 class="title"><a name="configuration-metadata-idp-signature"></a>Signature verification</h4></div></div></div>
				
				<p>Importing of digitally signed metadata requires verification of signature's validity and trust. Metadata is not required to be signed by default.
				When present, signature is verified with PKIX algorithm and uses all public keys present in the configured <span class="emphasis"><em>keyManager</em></span> as trust anchors. Make sure to include root CA
				certificate and intermediary CA certificates of the signature in your <span class="emphasis"><em>keyStore</em></span>. For details see <a class="xref" href="chapter-configuration.html#configuration-key-management-public-keys" title="4.5.3&nbsp;Importing public keys">Section&nbsp;4.5.3, &#8220;Importing public keys&#8221;</a>.</p>
				<p>You can limit certificates used to peform the verification by setting property <span class="emphasis"><em>metadataTrustedKeys</em></span> of the <span class="emphasis"><em>ExtendedMetadataDelegate</em></span> bean. The provided
				collection should contain aliases of keys to be used as trust anchors.</p>
				<p>Signature verification can be disabled by setting property <span class="emphasis"><em>metadataTrustCheck</em></span> to false in the <span class="emphasis"><em>ExtendedMetadataDelegate</em></span> bean.
				Setting <span class="emphasis"><em>metadataRequireSignature</em></span> to true will reject metadata unless it's digitally signed.</p>
			</div>
		</div>

		<div class="section" title="4.3.3&nbsp;Extended metadata"><div class="titlepage"><div><div><h3 class="title"><a name="configuration-metadata-extended"></a>4.3.3&nbsp;Extended metadata</h3></div></div></div>
			
			<p>Additional processing instructions related to SAML exchanges with the IDP can be defined in ExtendedMetadata bean. In case your metadata document contains
			multiple identity providers (in multiple EntityDescriptor elements) extended metadata can be set separately for each of them using a map with entity ids as keys, e.g.: </p><pre class="programlisting">&lt;bean class="org.springframework.security.saml.metadata.ExtendedMetadataDelegate"&gt;
	&lt;constructor-arg&gt;
		metadata provider bean
	&lt;/constructor-arg&gt;
	&lt;constructor-arg&gt;
		&lt;!-- Default extended metadata for entities not specified in the map --&gt;
		&lt;bean class="org.springframework.security.saml.metadata.ExtendedMetadata"/&gt;
	&lt;/constructor-arg&gt;
	&lt;constructor-arg&gt;
		&lt;!-- Extended metadata for specific IDPs --&gt;
		&lt;map&gt;
			&lt;entry key="http://idp.ssocircle.com"&gt;
				&lt;bean class="org.springframework.security.saml.metadata.ExtendedMetadata"/&gt;
			&lt;/entry&gt;
		&lt;/map&gt;
	&lt;/constructor-arg&gt;
&lt;/bean&gt;</pre>
			<p>For details about available settings of the ExtendedMetadata see <a class="xref" href="chapter-configuration-reference.html#reference-extended-metadata" title="A.1&nbsp;Extended metadata">Section&nbsp;A.1, &#8220;Extended metadata&#8221;</a>.</p>
		</div>
	</div>

	<div class="section" title="4.4&nbsp;Entity alias"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="configuration-entity-alias"></a>4.4&nbsp;Entity alias</h2></div></div></div>
		
		<p>TODO</p>
	</div>

	<div class="section" title="4.5&nbsp;Key management"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="configuration-key-management"></a>4.5&nbsp;Key management</h2></div></div></div>
		
		<p>
			SAML exchanges involve usage of cryptography for signing and encryption of data. All interaction with cryptographic keys is
			done through interface <span class="emphasis"><em>org.springframework.security.saml.key.KeyManager</em></span>. Default implementation relies
			on a single JKS key store which contains all private and public keys. KeyManager must contain at least one private key
			which should be marked as default by using the alias of the private key as part of the KeyManager constructor.
		</p>
		<p>
			Make sure that your configuration of SAML module contains bean keyManager with your custom key store and passwords.
		</p>

		<div class="section" title="4.5.1&nbsp;Sample keystore"><div class="titlepage"><div><div><h3 class="title"><a name="configuration-key-management-sample"></a>4.5.1&nbsp;Sample keystore</h3></div></div></div>
			
			<p>Sample application contains a default key store with a sample private certificate usable for test purposes. The key store
				is defined as:</p><pre class="programlisting">&lt;bean id="keyManager" class="org.springframework.security.saml.key.JKSKeyManager"&gt;
	&lt;constructor-arg value="classpath:security/samlKeystore.jks"/&gt;
	&lt;constructor-arg type="java.lang.String" value="nalle123"/&gt;
	&lt;constructor-arg&gt;
		&lt;map&gt;
			&lt;entry key="apollo" value="nalle123"/&gt;
		&lt;/map&gt;
	&lt;/constructor-arg&gt;
	&lt;constructor-arg type="java.lang.String" value="apollo"/&gt;
&lt;/bean&gt;</pre>
			 <p>The first argument points to the used key store file, second contains password for the keystore, third then map with
			 passwords for private keys with alias-password value pairs. Alias of the default certificate is the last parameter.</p>
		 </div>

		 <div class="section" title="4.5.2&nbsp;Generating and importing private keys"><div class="titlepage"><div><div><h3 class="title"><a name="configuration-key-management-private-keys"></a>4.5.2&nbsp;Generating and importing private keys</h3></div></div></div>
			 
			 <p>Private keys (with either self-signed or CA signed certificates) are used to digitally sign SAML messages,
			 encrypt their content and in some cases for SSL/TLS Client authentication of your service provider application.
			 SAML Extension ships with a default private key in the <span class="emphasis"><em>samlKeystore.jks</em></span> with alias <span class="emphasis"><em>apollo</em></span>
			 which can be used for initial testing, but for security reason should be replaced with your own key in early development stages.</p>
			 <p>In case your IDP doesn't require keys signed by a specific certification authority you can generate your own self-signed key using the
			 Java utility <span class="emphasis"><em>keytool</em></span>, e.g. with: </p><pre class="programlisting">keytool -genkeypair -alias some-alias -keypass changeit -keystore samlKeystore.jks</pre>
			 <p>The keystore will now contain additional PrivateKeyEntry with alias mykey which can be imported to the <span class="emphasis"><em>keyManager</em></span> in your <span class="emphasis"><em>securityContext.xml</em></span>.</p>
			 <p>Keys signed by certification authorities are typically provided in .p12/.pfx format (or can be converted to such using OpenSSL) and imported to Java keystore with, e.g.:
			 </p><pre class="programlisting">keytool -importkeystore -srckeystore key.p12 -srcstoretype PKCS12 -srcstorepass password \
-alias some-alias -destkeystore samlKeystore.jks -destalias some-alias -destkeypass changeit</pre>
<p>The following command can be used to determine available alias in the p12 file: </p><pre class="programlisting">keytool -list -keystore key.p12 -storetype pkcs12</pre>
		 </div>

		 <div class="section" title="4.5.3&nbsp;Importing public keys"><div class="titlepage"><div><div><h3 class="title"><a name="configuration-key-management-public-keys"></a>4.5.3&nbsp;Importing public keys</h3></div></div></div>
			 
			 <p>Cryptographic material used to decrypt incoming data and verify trust of signatures in SAML messages and metadata is stored either
			 in metadata of remote entities or in the <span class="emphasis"><em>keyManager</em></span>. In order to import additional trusted key to the keystore
			 run, e.g.: </p><pre class="programlisting">keytool -importcert -alias some-alias -file key.cer -keystore samlKeystore.jks</pre>
			 <p>Imported keys can be referenced in <span class="emphasis"><em>ExtendedMetadataDelegate</em></span> and <span class="emphasis"><em>ExtenedMetadata</em></span> beans,
			 for details see <a class="xref" href="chapter-configuration.html#configuration-metadata-idp-signature" title="Signature verification">the section called &#8220;Signature verification&#8221;</a> and <a class="xref" href="chapter-configuration.html#configuration-security-profiles" title="4.6&nbsp;Security profiles">Section&nbsp;4.6, &#8220;Security profiles&#8221;</a>.</p>
		 </div>

		 <div class="section" title="4.5.4&nbsp;Loading SSL/TLS certificates"><div class="titlepage"><div><div><h3 class="title"><a name="configuration-key-management-ssl-keys"></a>4.5.4&nbsp;Loading SSL/TLS certificates</h3></div></div></div>
			 
			 <p>Direct SSL/TLS connections (used with HTTP-Artifact binding) require verification of the public key presented by the server.
			 The <a class="ulink" href="https://github.com/vschafer/ssl-extractor" target="_top">SSL Extractor utility</a> can be used to extract certificates presented by an SSL/TLS
			 endpoint, e.g. with: </p><pre class="programlisting">java -jar sslextractor-0.9.jar www.google.com 443</pre>
			 <p>The certificates are stored as .cer files and can be imported to the keystore as a usual public key. For details about
			 configuring of trust for SSL/TLS connections see <a class="xref" href="chapter-configuration.html#configuration-security-profiles" title="4.6&nbsp;Security profiles">Section&nbsp;4.6, &#8220;Security profiles&#8221;</a>.</p>
		 </div>

	 </div>

	 <div class="section" title="4.6&nbsp;Security profiles"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="configuration-security-profiles"></a>4.6&nbsp;Security profiles</h2></div></div></div>
		 
		 <p>Exchanges of messages between identity providers and service providers with SAML protocol
			 involves usage of digital signatures. Signatures are typically constructed using means of asymetric
			 cryptography and public key infrastructure with public and private keys signed by trusted certification
			 authorities. Signatures are either applied directly to parts of XML representation of SAML messages
			 using XML Signature or are part of the transport layer used to deliver the message like SSL/TLS.
		 </p>
		 <p>Verification of signatures is executed in two phases. Signature is first checked for validity by
			 comparing digital hash included as part of the signature with value calculated from the content.
			 Subsequently it is verified whether party who created the signature is trusted by the recipient. Module
			 provides two mechanisms for defining which signatures should be accepted - metadata interoperability
			 mode and PKIX mode.
		 </p>
		 <p>
			 Security profiles are defined in Extended Metadata of your local SP. Profile can be defined separately
			 for XML Signatures using property <span class="emphasis"><em>securityProfile</em></span> and for SSL/TLS Signatures using
			 property<span class="emphasis"><em>sslSecurityProfile</em></span>. Value of both properties can be either <span class="emphasis"><em>metaiop</em></span>
			 or <span class="emphasis"><em>pkix</em></span>. For details about using Extended Metadata see <a class="xref" href="chapter-configuration.html#configuration-metadata" title="4.3&nbsp;Metadata configuration">Section&nbsp;4.3, &#8220;Metadata configuration&#8221;</a>,
			 for reference of allowed values see <a class="xref" href="chapter-configuration-reference.html#reference-extended-metadata" title="A.1&nbsp;Extended metadata">Section&nbsp;A.1, &#8220;Extended metadata&#8221;</a>.
		 </p>

		 <div class="section" title="4.6.1&nbsp;Metadata interoperability profile (MetaIOP)"><div class="titlepage"><div><div><h3 class="title"><a name="configuration-security-profiles-metaiop"></a>4.6.1&nbsp;Metadata interoperability profile (MetaIOP)</h3></div></div></div>
			 
			 <p>With MetaIOP mode certificates are not checked for expiration or revocation and certificate paths
				 are not
				 verified. This means that it does not matter which certification authority issued the certificate,
				 as the fact whether the certificate is trusted or not is conveyed using other mechanisms (e.g. by
				 secure metadata exchange or digital signature of metadata itself).
			 </p>
			 <p>Signature is deemed trusted when the certificate used to create it is included in one
				 of the following places:
				 </p><div class="itemizedlist"><ul class="itemizedlist" type="disc" compact><li class="listitem">
						 <p>Key with usage of signing or unspecified in entity metadata of a remote entity</p>
					 </li><li class="listitem">
						 <p>Signing key specified in property <span class="emphasis"><em>signingKey</em></span> of extended metadata of a remote entity</p>
					 </li></ul></div><p>
			 </p>
			 <p>
				 MetaIOP is the default profile for verification of XML signatures. For details about this profile
				 see <a class="ulink" href="http://docs.oasis-open.org/security/saml/Post2.0/sstc-metadata-iop.pdf" target="_top">the specification</a>.
			 </p>
		 </div>

		 <div class="section" title="4.6.2&nbsp;PKIX profile"><div class="titlepage"><div><div><h3 class="title"><a name="configuration-security-profiles-pkix"></a>4.6.2&nbsp;PKIX profile</h3></div></div></div>
			 
			 <p>
				 With PKIX profile trust of signature certificates is verified based on a certificate path
				 between trusted CA certificates and the certificate in question. Certificate is trusted when it's
				 possible to construct path from a trusted certificate to the validated one. With this profile
				 certificate expiration and revocation can be checked.
			 </p>
			 <p>Trusted keys (anchors) for PKIX verification of signatures are combined from the following places:
				 </p><div class="itemizedlist"><ul class="itemizedlist" type="disc" compact><li class="listitem">
						 <p>Key with usage of signing or unspecified in entity metadata of a remote entity</p>
					 </li><li class="listitem">
						 <p>Signing key specified in property <span class="emphasis"><em>signingKey</em></span> of extended metadata of a remote entity</p>
					 </li><li class="listitem">
						 <p>All keys specified in <span class="emphasis"><em>trustedKeys</em></span> set of extended metadata of a remote entity</p>
					 </li></ul></div><p>
			 </p>
		 </div>

		 <div class="section" title="4.6.3&nbsp;Custom profile"><div class="titlepage"><div><div><h3 class="title"><a name="configuration-security-profiles-customization"></a>4.6.3&nbsp;Custom profile</h3></div></div></div>
			 
			 <p>
				 Engine used to verify trust of signatures for given combination of SP/IDP is created in methods
				 <span class="emphasis"><em>populateTrustEngine</em></span> and <span class="emphasis"><em>populateSSLTrustEngine</em></span> of interface
				 <span class="emphasis"><em>org.springframework.security.saml.context.SAMLContextProvider</em></span> and can be overriden
				 with custom implementation. See <a class="xref" href="chapter-configuration.html#configuration-context-provider" title="4.12&nbsp;Context provider">Section&nbsp;4.12, &#8220;Context provider&#8221;</a> for details on context customization.
			 </p>
		 </div>
	 </div>

	 <div class="section" title="4.7&nbsp;Single sign-on process"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="configuration-sso"></a>4.7&nbsp;Single sign-on process</h2></div></div></div>
		 
		 <p>SP initialized SSO process can be started in two ways:
		 </p><div class="itemizedlist"><ul class="itemizedlist" type="disc" compact><li class="listitem">
				 <p>User accesses a resource protected by Spring Security which initializes SAMLEntryPoint</p>
			 </li><li class="listitem">
				 <p>User is redirected to the SSO page at e.g. https://www.server.com/context/saml/login/alias/defaultAlias</p>
			 </li></ul></div><p>
		 </p>
		 <p>After identification of IDP to use (for details see <a class="xref" href="chapter-configuration.html#configuration-discovery" title="4.8&nbsp;IDP selection">Section&nbsp;4.8, &#8220;IDP selection&#8221;</a>) SAML Extension creates an AuthnRequest SAML message
		 and sends it to the selected IDP. Both construction of the AuthnRequest and binding used to send it can be customized using <span class="emphasis"><em>WebSSOProfileOptions</em></span>
		 object. SAMLEntryPoint determines <span class="emphasis"><em>WebSSOProfileOptions</em></span> configuration to use by calling method <span class="emphasis"><em>getProfileOptions</em></span>.
		 Default implementation returns value specified in property <span class="emphasis"><em>defaultOptions</em></span>. Method can be overriden to provide custom logic for SSO initialization.</p>
		 <p>The following SSO parameters can be customized using the <span class="emphasis"><em>WebSSOProfileOptions</em></span> object:
		 </p><div class="table"><a name="configuration-sso-webssoprofile-table"></a><p class="title"><b>Table&nbsp;4.2.&nbsp;<span class="emphasis"><em>org.springframework.security.saml.websso.WebSSOProfileOptions</em></span> parameters</b></p><div class="table-contents">
			 
			 <table summary="org.springframework.security.saml.websso.WebSSOProfileOptions parameters" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col align="left"><col align="left"><col align="left"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Property</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Value</th><th style="border-bottom: 0.5pt solid ; " align="left">Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; " align="left">relayState</td><td style="border-right: 0.5pt solid ; " align="left">&nbsp;</td><td style="" align="left">Value is sent to IDP and provided back to SP as part of the authentication response.</td></tr></tbody></table>
		</div></div><p><br class="table-break"></p>
		<p>Default settings for <span class="emphasis"><em>WebSSOProfileOptions</em></span> can be specified in bean <span class="emphasis"><em>samlEntryPoint</em></span> of your securityContext.xml, e.g.:
		</p><pre class="programlisting">&lt;bean id="samlEntryPoint" class="org.springframework.security.saml.SAMLEntryPoint"&gt;
	&lt;property name="defaultProfileOptions"&gt;
		&lt;bean class="org.springframework.security.saml.websso.WebSSOProfileOptions"&gt;
			&lt;property name="binding" value="urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST"/&gt;
			&lt;property name="includeScoping" value="false"/&gt;
		&lt;/bean&gt;
	&lt;/property&gt;
&lt;/bean&gt;</pre>
	</div>

	<div class="section" title="4.8&nbsp;IDP selection"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="configuration-discovery"></a>4.8&nbsp;IDP selection</h2></div></div></div>
		
		<p>TODO</p>
		
	</div>

	<div class="section" title="4.9&nbsp;Logout process"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="configuration-logout"></a>4.9&nbsp;Logout process</h2></div></div></div>
		
		<p>TODO</p>
		
	</div>

	<div class="section" title="4.10&nbsp;Authentication object"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="configuration-authentication-object"></a>4.10&nbsp;Authentication object</h2></div></div></div>
		
		<p>Successful authentication using SAML token results in creation of an <span class="emphasis"><em>Authentication</em></span> object by
		the <span class="emphasis"><em>SAMLAuthenticationProvider</em></span>. By default instance of <span class="emphasis"><em>org.springframework.security.providers.ExpiringUsernameAuthenticationToken</em></span>
		is created. Content of the resulting object can be customized by setting properties of the <span class="emphasis"><em>samlAuthenticationProvider</em></span> bean in the <span class="emphasis"><em>securityContext.xml</em></span>.
		Instance of <span class="emphasis"><em>org.springframework.security.saml.userdetails.SAMLUserDetailsService</em></span> can be provided to supply application specific information about the
		authenticated user. Property <span class="emphasis"><em>forcePrincipalAsString</em></span> can be used to force String value of the <span class="emphasis"><em>principal</em></span> property. The Authentication object
		is available in pages secured with Spring Security using <span class="emphasis"><em>SecurityContextHolder.getContext().getAuthentication()</em></span> and is populated with the following values:

		</p><div class="table"><a name="authentication-object-table"></a><p class="title"><b>Table&nbsp;4.3.&nbsp;ExpiringUsernameAuthenticationToken values.</b></p><div class="table-contents">
			
			<table summary="ExpiringUsernameAuthenticationToken values." style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col align="left"><col align="left"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Property</th><th style="border-bottom: 0.5pt solid ; " align="left">Value</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Principal</td><td style="border-bottom: 0.5pt solid ; " align="left">When forcePrincipalAsString = false AND userDetail = null (default) - <span class="emphasis"><em>NameID</em></span> object included in the SAML Assertion (<span class="emphasis"><em>credential.getNameID()</em></span> of type <span class="emphasis"><em>org.opensaml.saml2.core.NameID</em></span>)</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Principal</td><td style="border-bottom: 0.5pt solid ; " align="left">When forcePrincipalAsString = true - <span class="emphasis"><em>String</em></span> value of <span class="emphasis"><em>NameID</em></span> included in the SAML Assertion (<span class="emphasis"><em>credential.getNameID().getValue()</em></span> of type java.lang.String)</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Principal</td><td style="border-bottom: 0.5pt solid ; " align="left">When forcePrincipalAsString = false AND userDetail != null - <span class="emphasis"><em>UserDetail</em></span> object returned from the <span class="emphasis"><em>SAMLUserDetailsService</em></span></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Credentials</td><td style="border-bottom: 0.5pt solid ; " align="left">SAML authentication object including entity ID of local and remote entity, name ID, assertion and relay state (<span class="emphasis"><em>org.springframework.security.saml.SAMLCredential</em></span>)</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left">Authorities</td><td style="border-bottom: 0.5pt solid ; " align="left">Result of <span class="emphasis"><em>getAuthorities()</em></span> call on the <span class="emphasis"><em>UserDetails</em></span> object returned from <span class="emphasis"><em>SAMLUserDetailsService</em></span>, empty list when there's no <span class="emphasis"><em>UserDetail</em></span> object available.</td></tr><tr><td style="border-right: 0.5pt solid ; " align="left">Expiration</td><td style="" align="left">Value of <span class="emphasis"><em>SessionNotOnOrAfter</em></span> in the SAML Assertion when avaialble, null otherwise. <span class="emphasis"><em>Authentication</em></span> object will start returning false on the <span class="emphasis"><em>isAuthenticated()</em></span> after the expiration time.</td></tr></tbody></table>
		</div></div><p><br class="table-break"></p>

		<p>Custom implementation of the <span class="emphasis"><em>SAMLUserDetailsService</em></span> can be provided as property <span class="emphasis"><em>userDetails</em></span> of the <span class="emphasis"><em>SAMLAuthenticationProvider</em></span>.
		Implementation can perform operation such as parsing of attributes present in the SAML Assertion, e.g.:
		</p><pre class="programlisting">package fi.schafer.test.saml;

import org.opensaml.saml2.core.Attribute;
import org.opensaml.xml.XMLObject;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.security.saml.SAMLCredential;
import org.springframework.security.saml.userdetails.SAMLUserDetailsService;

public class TestUserDetails implements SAMLUserDetailsService {

	@Override
	public Object loadUserBySAML(SAMLCredential credential) throws UsernameNotFoundException {
		Attribute accountID = credential.getAttributeByName("accountID");
		if (accountID == null || accountID.getAttributeValues() == null
					 || accountID.getAttributeValues().size() == 0) {
			return null;
		}
		XMLObject attributeValue = accountID.getAttributeValues().iterator().next();
		return attributeValue.getDOM().getTextContent();
	}

}</pre>

		<p>Population of the authentication object can be further customized by overriding of the <span class="emphasis"><em>getUserDetails</em></span>, <span class="emphasis"><em>getPrincipal</em></span>, <span class="emphasis"><em>getEntitlements</em></span> and <span class="emphasis"><em>getExpirationDate</em></span> methods
		in the <span class="emphasis"><em>SAMLAuthenticationProvider</em></span>.</p>

	</div>

	<div class="section" title="4.11&nbsp;Authentication log"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="configuration-authentication-log"></a>4.11&nbsp;Authentication log</h2></div></div></div>
		
		<p>Key events such as single sign-on and single logout initialization, success or failure can be logged for creation of an audit trail.
		A custom logger can be created by implementing interface <span class="emphasis"><em>org.springframework.security.saml.log.SAMLLogger</em></span> and including it's bean
		in the securityContext.xml, e.g.:</p><pre class="programlisting">&lt;bean id="samlLogger" class="org.springframework.security.saml.log.SAMLDefaultLogger"/&gt;</pre>
		<p>Two basic implementations are provided by default:
		</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
			  <p>org.springframework.security.saml.log.SAMLEmptyLogger</p>
			  <p>Doesn't perform any logging, simply ignores all events.</p>
		  </li><li class="listitem">
			  <p>org.springframework.security.saml.log.SAMLDefaultLogger</p>
			  <p>Logs events as INFO level messages to the standard log configurable as described in <a class="xref" href="chapter-troubleshooting.html#chapter-troubleshooting-logging" title="7.1&nbsp;Logging">Section&nbsp;7.1, &#8220;Logging&#8221;</a>. Setting
			  property <span class="emphasis"><em>logMessages</em></span> to <span class="emphasis"><em>true</em></span> will include content of the SAML messages as part of the log. Logging of exceptions
        can be disalbed by setting <span class="emphasis"><em>logErrors</em></span> to <span class="emphasis"><em>false</em></span>.</p>
		  </li></ul></div>
	</div>

	<div class="section" title="4.12&nbsp;Context provider"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="configuration-context-provider"></a>4.12&nbsp;Context provider</h2></div></div></div>
		
		<p>Context provider populates information about the local service provider (your application) such as entityId, role, metadata, security keys, SSL credetials
		and trust engines for verification of signatures and SSL/TLS connections. Once populated context is made available to all components participating
		in processing of the incoming or outgoing SAML messages. ContextProvider can customized to alter behavior of the SAML Extension. The default
		implementation <span class="emphasis"><em>org.springframework.security.saml.context.SAMLContextProviderImpl</em></span> relies on information available in the ExtendedMetadata and
		performs the followign steps for creation of the context:

		</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
					<p>Locate entityId of the local SP by parsing part of the URL after <span class="emphasis"><em>/alias/</em></span> (e.g. myAlias in https://www.myserver.com/saml_extension/saml/sso/alias/myAlias?idp=myIdp) and match
					it with property <span class="emphasis"><em>alias</em></span> specified in the ExtendedMetadata. In case URL doesn't contain any alias part the default service provider
					configured with property <span class="emphasis"><em>hostedSPName</em></span> on the <span class="emphasis"><em>metadata</em></span> bean is used.</p>
				</li><li class="listitem">
					<p>Populate credential used to decrypt data sent to this service provider. In case ExtendedMetadata specifies property <span class="emphasis"><em>encryptionKey</em></span>
					it will be used as an alias to lookup a private key from the <span class="emphasis"><em>keyManager</em></span> bean. Otherwise defaultKey of the <span class="emphasis"><em>keyManager</em></span> bean will be used.</p>
				</li><li class="listitem">
					<p>Populate credential used for SSL/TLS client authentication. In case ExtendedMetadata specifies property <span class="emphasis"><em>tlsKey</em></span> it will be used
					as an alias to lookup key from <span class="emphasis"><em>keyManager</em></span> bean. Otherwise no credential will be provided for client authentication.</p>
				</li><li class="listitem">
					<p>Populate trust engine for verification of signatures. Depending on <span class="emphasis"><em>securityProfile</em></span> setting in the ExtendedMetadata trust engine
					based on either <a class="xref" href="chapter-configuration.html#configuration-security-profiles-metaiop" title="4.6.1&nbsp;Metadata interoperability profile (MetaIOP)">Section&nbsp;4.6.1, &#8220;Metadata interoperability profile (MetaIOP)&#8221;</a> or <a class="xref" href="chapter-configuration.html#configuration-security-profiles-pkix" title="4.6.2&nbsp;PKIX profile">Section&nbsp;4.6.2, &#8220;PKIX profile&#8221;</a> is created.</p>
				</li><li class="listitem">
					<p>Populate trust engine for verification of SSL/TLS connections. Depending on <span class="emphasis"><em>sslSecurityProfile</em></span> setting in the ExtendedMetadata
					trust engine based on either <a class="xref" href="chapter-configuration.html#configuration-security-profiles-metaiop" title="4.6.1&nbsp;Metadata interoperability profile (MetaIOP)">Section&nbsp;4.6.1, &#8220;Metadata interoperability profile (MetaIOP)&#8221;</a> or <a class="xref" href="chapter-configuration.html#configuration-security-profiles-pkix" title="4.6.2&nbsp;PKIX profile">Section&nbsp;4.6.2, &#8220;PKIX profile&#8221;</a> is created.</p>
				</li></ul></div>

		<p>During initialization of SSO ContextProvider is also requested to provide metadata of the peer IDP. System performs these steps to locate peer IDP to use:

		</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
					<p>Load parameter <span class="emphasis"><em>idp</em></span> of the HttpRequest object and try to locate peer IDP by the entityId. When there's no <span class="emphasis"><em>idp</em></span>
					parameter provided system will either start IDP discovery process (when enabled in the ExtendedMetadata of the local SP) or use the default IDP specified in the
					<span class="emphasis"><em>metadata</em></span> bean.</p>
				</li></ul></div>
	</div>

	<div class="section" title="4.13&nbsp;Validity intervals"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="time-interval"></a>4.13&nbsp;Validity intervals</h2></div></div></div>
		
		<p>For security reasons system limits the time window enabling processing of SAML messages and assertions. The time window parameters can be customized with the following settings.</p> 
		<p>Validity of assertions processed during the signle sign-on process is limited to 3000 seconds. Value can be customized with property <span class="emphasis"><em>maxAssertionTime</em></span>
		of the <span class="emphasis"><em>WebSSOProfileConsumerImpl</em></span> bean.</p>
		<p>System allows users to single sign-on for up to 7200 seconds since their initial authentication with the IDP (based on value AuthInstance of the Authentication statement).
		Some IDPs allow users to stay authenticated for longer periods than this and you might need to change the default value by setting <span class="emphasis"><em>maxAuthenticationAge</em></span> 
		of the <span class="emphasis"><em>WebSSOProfileConsumerImpl</em></span> bean.</p>
		<p>As clocks between IDP and SP machines may not be perfectly synchronized a tolerance of 60 seconds is applied for time comparisons. The tolerance value (time skew) can be customized
		by settings property <span class="emphasis"><em>responseSkew</em></span> in beans <span class="emphasis"><em>WebSSOProfileConsumerImpl</em></span> and <span class="emphasis"><em>SingleLogoutProfileImpl</em></span>.</p>
	</div>

	<div class="section" title="4.14&nbsp;Load balancing"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="load-balancing"></a>4.14&nbsp;Load balancing</h2></div></div></div>
		
		<p>SAML Extension can be deployed in scenarios where mutliple back-end servers process SAML requests forwarded by a reverse-proxy or a load balancer.
		SSL termination proxies which communicate using an unencrypted channel between the proxy and back-end servers are also supported. In order
		to confugure SAML Extension for deployment behing a load balancer or a reverse-proxy please follow these steps:

		</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
					<p>Make sure that your reverse-proxy or load-balancer is configured to use sticky sessions. Information about e.g. sent requests is stored
					within user's HTTP session and sending of response to another back-end node would make the original request data unavailable and fail the validation.
					Sticky session are not necessary in case only IDP-initialized SSO is used.</p>
				</li><li class="listitem">
					<p>Provide information about front-end URL to the back-end servers by changing the <span class="emphasis"><em>contextProvider</em></span> bean implementation in your <span class="emphasis"><em>securityContex.xml</em></span>
					to class <span class="emphasis"><em>org.springframework.security.saml.context.SAMLContextProviderLB</em></span>: </p><pre class="programlisting">&lt;bean id="contextProvider" class="org.springframework.security.saml.context.SAMLContextProviderLB"&gt;
	&lt;property name="scheme" value="https"/&gt;
	&lt;property name="serverName" value="www.myserver.com"/&gt;
	&lt;property name="serverPort" value="443"/&gt;
	&lt;property name="includeServerPortInRequestURL" value="false"/&gt;
	&lt;property name="contextPath" value="/spring-security-saml2-sample"/&gt;
&lt;/bean&gt;</pre>
				  <p>This setting enables extension to correctly form all generated URLs and verify endpoints of the incoming SAML messages.</p>
				</li><li class="listitem">
					<p>In case you use automatically generated metadata make sure to configure <span class="emphasis"><em>entityBaseUrl</em></span> matching the front-end URL in your <span class="emphasis"><em>metadataGeneratorFilter</em></span>
					bean: </p><pre class="programlisting">&lt;bean id="metadataGeneratorFilter"
		class="org.springframework.security.saml.metadata.MetadataGeneratorFilter"&gt;
	&lt;constructor-arg&gt;
		&lt;bean class="org.springframework.security.saml.metadata.MetadataGenerator"&gt;
			&lt;property name="entityBaseURL" value="https://www.myserver.com/spring-security-saml2-sample"/&gt;
		&lt;/bean&gt;
	&lt;/constructor-arg&gt;
&lt;/bean&gt;</pre>
				</li></ul></div><p>

		</p>
	</div>

	

</div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="integration.html">Prev</a>&nbsp;</td><td width="20%" align="center"><a accesskey="u" href="integration.html">Up</a></td><td width="40%" align="right">&nbsp;<a accesskey="n" href="chapter-administration-ui.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Part&nbsp;II.&nbsp;Configuring SSO with SAML&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;5.&nbsp;Administration user interface</td></tr></table></div></body></html>