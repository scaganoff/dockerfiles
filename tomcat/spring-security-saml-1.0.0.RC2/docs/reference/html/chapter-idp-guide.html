<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>6.&nbsp;IDP integration guide</title><link rel="stylesheet" href="css/manual-multipage.css" type="text/css"><meta name="generator" content="DocBook XSL Stylesheets V1.75.2"><link rel="home" href="index.html" title="Spring Security SAML Extension"><link rel="up" href="integration.html" title="Part&nbsp;II.&nbsp;Configuring SSO with SAML"><link rel="prev" href="chapter-administration-ui.html" title="5.&nbsp;Administration user interface"><link rel="next" href="chapter-troubleshooting.html" title="7.&nbsp;Troubleshooting"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">6.&nbsp;IDP integration guide</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="chapter-administration-ui.html">Prev</a>&nbsp;</td><th width="60%" align="center">Part&nbsp;II.&nbsp;Configuring SSO with SAML</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="chapter-troubleshooting.html">Next</a></td></tr></table><hr></div><div class="chapter" title="6.&nbsp;IDP integration guide"><div class="titlepage"><div><div><h2 class="title"><a name="chapter-idp-guide"></a>6.&nbsp;IDP integration guide</h2></div></div></div>
		
		<p>This chapter provides step-by-step guides for basic configuration of SAML Extension with specific
		IDP products. Integration can be further configured with settings discussed in previous chapters.</p>

		<div class="section" title="6.1&nbsp;Active Directory Federation Services 2.0 (ADFS)"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="chapter-idp-guide-adfs"></a>6.1&nbsp;Active Directory Federation Services 2.0 (ADFS)</h2></div></div></div>
			

			<p>ADFS 2.0 supports SAML 2.0 in IDP mode and can be easily integrated with SAML Extension for both SSO and SLO.
			Before starting with the configuration make sure that the following pre-requisites are satisfied:</p>
			<div class="itemizedlist"><ul class="itemizedlist" type="disc" compact><li class="listitem">
						<p>Install AD FS 2.0 (http://www.microsoft.com/en-us/download/details.aspx?id=10909)</p>
					</li><li class="listitem">
						<p>Run AD FS 2.0 Federation Server Configuration Wizard in the AD FS 2.0 Management Console</p>
					</li><li class="listitem">
						<p>Make sure that DNS name of your Windows Server is available at your SP and vice-versa</p>
					</li><li class="listitem">
						<p>Install a Java container (e.g. Tomcat) for deployment of the SAML 2 Extension</p>
					</li><li class="listitem">
						<p>Configure your container to use HTTPS, this is required by AD FS (<a class="ulink" href="http://tomcat.apache.org/tomcat-6.0-doc/ssl-howto.html" target="_top">http://tomcat.apache.org/tomcat-6.0-doc/ssl-howto.html</a>)</p>
					</li></ul></div>

			<div class="section" title="6.1.1&nbsp;Initialize IDP metadata"><div class="titlepage"><div><div><h3 class="title"><a name="chapter-idp-guide-adfs-idp"></a>6.1.1&nbsp;Initialize IDP metadata</h3></div></div></div>
			
			<div class="itemizedlist"><ul class="itemizedlist" type="disc" compact><li class="listitem">
						<p>Download AD FS 2.0 metadata from <span class="emphasis"><em>https://server/FederationMetadata/2007-06/FederationMetadata.xml</em></span></p>
					</li><li class="listitem">
						<p>Store the downloaded content to saml2-sample/WEB-INF/src/main/resources/security/FederationMetadata.xml</p>
					</li><li class="listitem">
						<p>Modify bean <span class="emphasis"><em>metadata</em></span> in <span class="emphasis"><em>securityContext.xml</em></span> and replace <span class="emphasis"><em>classpath:security/idp.xml</em></span> with <span class="emphasis"><em>classpath:security/FederationMetadata.xml</em></span> and add property <span class="emphasis"><em>metadataTrustCheck</em></span> to <span class="emphasis"><em>false</em></span> to skip signature validation:
</p><pre class="programlisting">&lt;bean class="org.springframework.security.saml.metadata.ExtendedMetadataDelegate"&gt;
	&lt;constructor-arg&gt;
		&lt;bean class="org.opensaml.saml2.metadata.provider.FilesystemMetadataProvider"&gt;
			&lt;constructor-arg&gt;
				&lt;value type="java.io.File"&gt;classpath:security/FederationMetadata.xml&lt;/value&gt;
			&lt;/constructor-arg&gt;
			&lt;property name="parserPool" ref="parserPool"/&gt;
		&lt;/bean&gt;
	&lt;/constructor-arg&gt;
	&lt;constructor-arg&gt;
		&lt;bean class="org.springframework.security.saml.metadata.ExtendedMetadata"/&gt;
	&lt;/constructor-arg&gt;
	&lt;property name="metadataTrustCheck" value="false"/&gt;
&lt;/bean&gt;</pre><p>
					</p>
				</li></ul></div>
		</div>

		<div class="section" title="6.1.2&nbsp;Initialize SP metadata"><div class="titlepage"><div><div><h3 class="title"><a name="chapter-idp-guide-adfs-sp"></a>6.1.2&nbsp;Initialize SP metadata</h3></div></div></div>
		
		<div class="itemizedlist"><ul class="itemizedlist" type="disc" compact><li class="listitem">
					<p>Deploy SAML 2 Extension war archive from <span class="emphasis"><em>saml2-sample/target/spring-security-saml2-sample.war</em></span></p>
				</li><li class="listitem">
					<p>Open browser at e.g. https://server:port/spring-security-saml2-sample, make sure to use HTTPS protocol, system will automatically generate metadata document</p>
				</li><li class="listitem">
					<p>Click Metadata information, select item with your server name in the Service providers list</p>
				</li><li class="listitem">
					<p>Store content of the Metadata field to a document metadata.xml and upload it to the AD FS server</p>
				</li><li class="listitem">
					<p>In AD FS 2.0 Management Console select "Add Relying Party Trust"</p>
				</li><li class="listitem">
					<p>Select "Import data about the relying party from a file" and select file created earlier, select Next</p>
				</li><li class="listitem">
					<p>System may complain that some content of metadata is not supported, you can safely ignore this warning</p>
				</li><li class="listitem">
					<p>Continue with the wizard, on the "Ready to Add Trust" make sure that tab endpoints contains multiple endpoing values, if not verify that your metadata was generated with https protocol in their URLs</p>
				</li><li class="listitem">
					<p>Leave "Open the Edit Claim Rules dialog" checkbox checked and finish the wizard</p>
				</li><li class="listitem">
					<p>Select "Add Rule", choose "Send LDAP Attributes as Claims" and press Next</p>
				</li><li class="listitem">
					<p>Add NameID as "Claim rule name", choose "Active Directory" as Attribute store, choose "SAM-Account-Name" as LDAP Attribute and "Name ID" as "Outgoing claim type", finish the wizard and confirm the claim rules window</p>
				</li><li class="listitem">
					<p>Open the provider by double-clicking it, select tab Advanced and change "Secure hash algorithm" to SHA-1</p>
				</li></ul></div>
		</div>

		<div class="section" title="6.1.3&nbsp;Test SSO"><div class="titlepage"><div><div><h3 class="title"><a name="chapter-idp-guide-adfs-test"></a>6.1.3&nbsp;Test SSO</h3></div></div></div>
		
		<p>Open SAML Extension at https://localhost:8443/spring-security-saml2-sample, select your AD FS server and press login. In case Artifact binding
		is used and SSL/TLS certificate of your AD FS is not already trusted you have to import it to your samlKeystore.jks by following instructions in the
		error report.</p>
		</div>

	</div>

</div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="chapter-administration-ui.html">Prev</a>&nbsp;</td><td width="20%" align="center"><a accesskey="u" href="integration.html">Up</a></td><td width="40%" align="right">&nbsp;<a accesskey="n" href="chapter-troubleshooting.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">5.&nbsp;Administration user interface&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;7.&nbsp;Troubleshooting</td></tr></table></div></body></html>